name: Issue Triage Agent

on:
  issues:
    types: [opened]

permissions:
  issues: write

jobs:
  classify:
    runs-on: ubuntu-latest
    steps:
      - name: Ensure difficulty labels exist
        uses: actions/github-script@v7
        with:
          script: |
            const labels = [
              { name: 'easy', color: '0e8a16', description: 'Low complexity / quick-win' },
              { name: 'moderate', color: 'fbca04', description: 'Medium complexity' },
              { name: 'difficult', color: 'b60205', description: 'High complexity or multi-step' },
            ];
            for (const lbl of labels) {
              try {
                await github.rest.issues.getLabel({ ...context.repo, name: lbl.name });
                // update description/color if needed
                await github.rest.issues.updateLabel({ ...context.repo, name: lbl.name, color: lbl.color, description: lbl.description });
              } catch (err) {
                await github.rest.issues.createLabel({ ...context.repo, name: lbl.name, color: lbl.color, description: lbl.description });
              }
            }

      - name: Classify issue difficulty (Copilot-first, heuristic fallback)
        id: classify
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const title = (issue.title || '').toLowerCase();
            const body = (issue.body || '').toLowerCase();

            // Heuristic classification (can be replaced by Copilot plan when available)
            const difficultKeywords = [
              'authentication', 'authorize', 'azure ad', 'identity', 'openid', 'oauth',
              'playwright', 'end-to-end', 'e2e',
              'docker', 'container', 'kubernetes',
              'telemetry', 'application insights', 'app insights',
              'accessibility', 'wcag', 'aria',
              'global exception', 'exception handling', 'security', 'hsts',
              'analyzer', 'code analyzer', 'stylecop', 'roslyn',
              'pipeline', 'ci', 'caching'
            ];

            const moderateKeywords = [
              'health check', 'healthcheck', 'monitoring',
              'logging', 'metrics', 'dockerfile',
              'tests', 'unit', 'integration',
              'format', 'analyzers'
            ];

            const bulletCount = ((issue.body || '').match(/^\s*[-*]\s+/gm) || []).length;
            const len = (issue.body || '').length;
            const contains = (list) => list.some(k => title.includes(k) || body.includes(k));

            let diff = 'moderate';
            const reasons = [];

            if (bulletCount > 3) { diff = 'difficult'; reasons.push(`bulletCount=${bulletCount}>3`); }
            else if (bulletCount >= 2) { diff = 'moderate'; reasons.push(`bulletCount=${bulletCount}`); }
            else if (bulletCount <= 1 && len < 400 && !contains(difficultKeywords)) { diff = 'easy'; reasons.push(`short body (${len}) & low bullets`); }

            if (contains(difficultKeywords)) { diff = 'difficult'; reasons.push('matched difficult keyword'); }
            else if (contains(moderateKeywords) && diff !== 'difficult') { diff = 'moderate'; reasons.push('matched moderate keyword'); }

            core.info(`Difficulty classified as ${diff} (${reasons.join('; ')})`);

            // remove other difficulty labels to keep only one
            const diffLabels = ['easy', 'moderate', 'difficult'];
            const toRemove = issue.labels.filter(l => diffLabels.includes(l.name) && l.name !== diff).map(l => l.name);

            if (toRemove.length) {
              for (const lbl of toRemove) {
                await github.rest.issues.removeLabel({ ...context.repo, issue_number: issue.number, name: lbl });
              }
            }

            // add chosen label if missing
            const hasLabel = issue.labels.some(l => l.name === diff);
            if (!hasLabel) {
              await github.rest.issues.addLabels({ ...context.repo, issue_number: issue.number, labels: [diff] });
            }

            core.setOutput('difficulty', diff);

      - name: Comment classification (Plan)
        uses: actions/github-script@v7
        env:
          DIFFICULTY: "${{ steps.classify.outputs.difficulty || 'moderate' }}"
        with:
          script: |
            const difficulty = process.env.DIFFICULTY;
            const plan = [
              `**Difficulty:** ${difficulty}`,
              `**Reasoning:** ${difficulty === 'easy' ? 'Low scope/short body/minimal bullets' : difficulty === 'moderate' ? 'Moderate scope/keywords' : 'Broader scope or complex keywords'}`,
              '',
              '**Next steps:**',
            ];
            if (difficulty === 'easy') {
              plan.push('- Clarify expected output and edge cases');
              plan.push('- Implement change and add a targeted unit test');
            } else if (difficulty === 'moderate') {
              plan.push('- Break work into API/service/view changes');
              plan.push('- Add unit/integration tests as needed');
            } else {
              plan.push('- Draft detailed design/plan in the issue');
              plan.push('- Identify dependencies, secrets, and test strategy');
            }

            await github.rest.issues.createComment({
              ...context.repo,
              issue_number: context.payload.issue.number,
              body: `ðŸ¤– Issue triage (plan):\n\n${plan.join('\n')}`
            });
