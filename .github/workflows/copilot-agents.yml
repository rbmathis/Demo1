name: Copilot Agent Triggered Tasks

on:
  pull_request:
    types: [opened, synchronize]
  push:
    branches: [main]
  schedule:
    - cron: "0 2 * * 1" # Weekly security scan

jobs:
  code-review-agent:
    name: Code Review Agent
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Analyze MVC Patterns
        run: |
          echo "üîç Analyzing MVC patterns..."

          # Check for proper controller structure
          echo "üìÅ Controllers found:"
          find Controllers -name "*.cs" 2>/dev/null || echo "No controllers directory found"

          # Check for proper model structure
          echo "üìä Models found:"
          find Models -name "*.cs" 2>/dev/null || echo "No models directory found"

          # Check for proper view structure
          echo "üé® Views found:"
          find Views -name "*.cshtml" 2>/dev/null || echo "No views directory found"

      - name: Security Analysis
        run: |
          echo "üõ°Ô∏è Security check..."

          # Check for authentication configuration
          if grep -r "AddAuthentication\|AddAuthorization" . --include="*.cs"; then
            echo "‚úÖ Authentication configuration found"
          else
            echo "‚ö†Ô∏è No authentication configuration detected"
          fi

          # Check for HTTPS redirection
          if grep -r "UseHttpsRedirection" . --include="*.cs"; then
            echo "‚úÖ HTTPS redirection configured"
          else
            echo "‚ö†Ô∏è HTTPS redirection not found"
          fi

  build-validator-agent:
    name: Build Validator Agent
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Validate Project Files
        run: |
          echo "üìã Validating project structure..."

          # Check for required files
          if [ -f "Program.cs" ]; then
            echo "‚úÖ Program.cs found"
          else
            echo "‚ùå Program.cs missing"
          fi

          if [ -f "appsettings.json" ]; then
            echo "‚úÖ appsettings.json found"
          else
            echo "‚ùå appsettings.json missing"
          fi

      - name: Build and Test
        run: |
          echo "üî® Building project..."
          dotnet restore
          dotnet build --configuration Release
          echo "‚úÖ Build completed successfully"

  security-auditor-agent:
    name: Security Auditor Agent
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'pull_request'

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Dependency Security Scan
        run: |
          echo "üîí Security audit..."
          dotnet restore
          dotnet list package --vulnerable --include-transitive || echo "No known vulnerabilities found"

      - name: Configuration Security Check
        run: |
          echo "‚öôÔ∏è Configuration security check..."

          # Check for sensitive data in appsettings
          if grep -i "password\|secret\|key" appsettings*.json; then
            echo "‚ö†Ô∏è Potential sensitive data in configuration files"
          else
            echo "‚úÖ No sensitive data detected in configuration"
          fi

  documentation-helper-agent:
    name: Documentation Helper Agent
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check Documentation
        run: |
          echo "üìö Documentation check..."

          # Check README
          if [ -f "README.md" ]; then
            echo "‚úÖ README.md exists"
            if grep -q "Getting Started\|Installation\|Usage" README.md; then
              echo "‚úÖ README contains helpful sections"
            else
              echo "‚ö†Ô∏è README could use Getting Started or Usage sections"
            fi
          else
            echo "‚ùå README.md missing"
          fi

          # Check for XML documentation in controllers
          if grep -r "/// <summary>" Controllers/ 2>/dev/null; then
            echo "‚úÖ XML documentation found in controllers"
          else
            echo "‚ö†Ô∏è Consider adding XML documentation to controllers"
          fi

      - name: Check new public code for XML docs
        id: xml-doc-check
        env:
          PR_BASE: ${{ github.base_ref }}
        run: |-
          set -e
          echo "üîé Checking new/modified C# files for XML documentation on public APIs..."

          # Determine diff range
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            git fetch --no-tags --prune --depth=1 origin "$PR_BASE"
            DIFF_RANGE="origin/${PR_BASE}...${{ github.sha }}"
          else
            BEFORE="${{ github.event.before }}"
            if [ -z "$BEFORE" ] || [ "$BEFORE" = "0000000000000000000000000000000000000000" ]; then
              BEFORE=$(git rev-list --max-parents=0 HEAD)
            fi
            DIFF_RANGE="$BEFORE..${{ github.sha }}"
          fi

          echo "Using diff range: $DIFF_RANGE"

          # Get changed C# files (exclude bin/obj)
          CHANGED_FILES=$(git diff --name-only "$DIFF_RANGE" -- '*.cs' ':!**/bin/**' ':!**/obj/**' ':!**/*.Designer.cs')

          if [ -z "$CHANGED_FILES" ]; then
            echo "‚úÖ No C# files changed; skipping XML doc check."
            exit 0
          fi

          echo "Changed C# files:"
          echo "$CHANGED_FILES"

          cat > /tmp/xml_doc_check.py <<'PYCODE'
          import re, sys
          from pathlib import Path

          missing = []

          def check_file(path: Path):
              text = path.read_text(encoding='utf-8', errors='ignore').splitlines()
              prev_has_xml = False
              for idx, line in enumerate(text):
                  if re.match(r"\s*///", line):
                      prev_has_xml = True
                      continue
                  # Look for public declarations (class/interface/struct/enum/record/delegate, methods, properties)
                  if re.match(r"\s*public\s+", line):
                      # ignore auto-generated backing fields etc.
                      if re.search(r"class|interface|struct|enum|record|delegate", line) or "(" in line or "{" in line:
                          if not prev_has_xml:
                              missing.append(f"{path}:{idx+1}: Missing XML doc -> {line.strip()}")
                      prev_has_xml = False
                  else:
                      prev_has_xml = False

          for file in sys.stdin.read().splitlines():
              if not file.strip():
                  continue
              check_file(Path(file))

          if missing:
              print("\n‚ùå Missing XML documentation for public declarations:")
              for m in missing:
                  print(m)
              sys.exit(1)
          else:
              print("‚úÖ All public declarations in changed files have XML docs.")
          PYCODE

          echo "$CHANGED_FILES" | python3 /tmp/xml_doc_check.py
