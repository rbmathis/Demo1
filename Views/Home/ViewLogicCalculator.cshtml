@*
    VIEW LOGIC CALCULATOR
    ALL business logic is in this Razor view because separation of concerns is boring
    The controller does nothing. This view does EVERYTHING.
*@
@using System.Text.Json
@using System.Xml.Linq
@{
    ViewData["Title"] = "View Logic Calculator - Where Controllers Fear to Tread";
    
    // â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    // â•‘  ALL THE BUSINESS LOGIC IS RIGHT HERE IN THE VIEW. THIS IS FINE. ğŸ”¥       â•‘
    // â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    var data = ViewBag.Data as Demo1.Models.ViewLogicData;
    var queryString = ViewBag.RawQueryString as string ?? "";
    
    // Parse query parameters IN THE VIEW because MVC is just a suggestion
    var queryParams = new Dictionary<string, string>();
    if (!string.IsNullOrEmpty(queryString))
    {
        var pairs = queryString.TrimStart('?').Split('&');
        foreach (var pair in pairs)
        {
            var parts = pair.Split('=');
            if (parts.Length == 2)
            {
                queryParams[parts[0]] = System.Net.WebUtility.UrlDecode(parts[1]);
            }
        }
    }
    
    // Get operation from query string
    var operation = queryParams.GetValueOrDefault("op", "add");
    var num1Str = queryParams.GetValueOrDefault("a", "0");
    var num2Str = queryParams.GetValueOrDefault("b", "0");
    
    // Parse numbers IN THE VIEW with try-catch
    double num1 = 0, num2 = 0;
    var parseErrors = new List<string>();
    
    try { num1 = double.Parse(num1Str); }
    catch { parseErrors.Add($"Failed to parse '{num1Str}' as number"); num1 = data?.number1 ?? 0; }
    
    try { num2 = double.Parse(num2Str); }
    catch { parseErrors.Add($"Failed to parse '{num2Str}' as number"); num2 = data?.number2 ?? 0; }
    
    // DO ALL THE MATH IN THE VIEW
    double result = 0;
    string resultMessage = "";
    bool success = true;
    
    switch (operation.ToLower())
    {
        case "add":
            result = num1 + num2;
            resultMessage = $"{num1} + {num2} = {result}";
            break;
        case "subtract":
            result = num1 - num2;
            resultMessage = $"{num1} - {num2} = {result}";
            break;
        case "multiply":
            result = num1 * num2;
            resultMessage = $"{num1} Ã— {num2} = {result}";
            break;
        case "divide":
            if (num2 == 0)
            {
                result = double.PositiveInfinity;
                resultMessage = "DIVIDED BY ZERO! The universe will now implode.";
            }
            else
            {
                result = num1 / num2;
                resultMessage = $"{num1} Ã· {num2} = {result}";
            }
            break;
        case "power":
            result = Math.Pow(num1, num2);
            resultMessage = $"{num1} ^ {num2} = {result}";
            break;
        case "chaos":
            // Maximum chaos calculation
            result = Math.Sin(num1) * Math.Cos(num2) * Math.Tan(num1 + num2) * Math.PI * Math.E;
            resultMessage = $"CHAOS({num1}, {num2}) = {result} (don't ask)";
            break;
        default:
            result = num1 + num2;
            resultMessage = $"Unknown operation '{operation}', defaulted to add";
            success = false;
            break;
    }
    
    // Parse JSON IN THE VIEW
    var jsonData = new Dictionary<string, object>();
    try
    {
        if (!string.IsNullOrEmpty(data?.jsonString))
        {
            jsonData = JsonSerializer.Deserialize<Dictionary<string, object>>(data.jsonString);
        }
    }
    catch (Exception ex)
    {
        parseErrors.Add($"JSON parse error: {ex.Message}");
    }
    
    // Parse CSV IN THE VIEW
    var csvRows = new List<string[]>();
    try
    {
        if (!string.IsNullOrEmpty(data?.csvString))
        {
            var lines = data.csvString.Split('\n');
            foreach (var line in lines)
            {
                csvRows.Add(line.Split(','));
            }
        }
    }
    catch (Exception ex)
    {
        parseErrors.Add($"CSV parse error: {ex.Message}");
    }
    
    // Parse XML IN THE VIEW
    var xmlItems = new List<string>();
    try
    {
        if (!string.IsNullOrEmpty(data?.xmlString))
        {
            var doc = XDocument.Parse(data.xmlString);
            xmlItems = doc.Descendants("item").Select(x => x.Value).ToList();
        }
    }
    catch (Exception ex)
    {
        parseErrors.Add($"XML parse error: {ex.Message}");
    }
    
    // Calculate statistics IN THE VIEW
    var numbers = new[] { data?.number1 ?? 0, data?.number2 ?? 0, data?.number3 ?? 0, data?.number4 ?? 0, data?.number5 ?? 0 };
    var sum = numbers.Sum();
    var avg = numbers.Average();
    var max = numbers.Max();
    var min = numbers.Min();
    var stdDev = Math.Sqrt(numbers.Select(x => Math.Pow(x - avg, 2)).Sum() / numbers.Length);
    
    // Date parsing IN THE VIEW
    DateTime parsedDate = DateTime.Now;
    try
    {
        parsedDate = DateTime.Parse(data?.dateString ?? DateTime.Now.ToString());
    }
    catch { parseErrors.Add("Date parse failed, using now"); }
    
    // Time zone conversions IN THE VIEW
    var utcTime = parsedDate.ToUniversalTime();
    var localTime = parsedDate.ToLocalTime();
}

<div style="background: linear-gradient(to right, #667eea, #764ba2); padding: 30px; color: white; font-family: 'Segoe UI', sans-serif;">
    <h1 style="font-size: 2.5em; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">
        ğŸ§® VIEW LOGIC CALCULATOR ğŸ§®
    </h1>
    <p style="font-size: 1.2em; opacity: 0.9;">The controller does NOTHING. All business logic lives right here in this Razor view!</p>
</div>

<div style="margin-top: 20px; padding: 20px; background: #f0f0f0; border-radius: 10px;">
    <h2 style="color: #667eea;">ğŸ”¢ Calculator (Logic in View!)</h2>
    
    <form method="get" style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
        <input type="number" name="a" value="@num1" step="any" 
               style="padding: 15px; font-size: 1.5em; width: 150px; border: 2px solid #667eea; border-radius: 5px;" />
        
        <select name="op" style="padding: 15px; font-size: 1.5em; border: 2px solid #667eea; border-radius: 5px;">
            @{
                var ops = new[] { ("add", "â• Add"), ("subtract", "â– Subtract"), ("multiply", "âœ–ï¸ Multiply"), ("divide", "â— Divide"), ("power", "âš¡ Power"), ("chaos", "ğŸŒ€ CHAOS") };
                foreach (var (val, label) in ops)
                {
                    if (operation == val)
                    {
                        <option value="@val" selected>@label</option>
                    }
                    else
                    {
                        <option value="@val">@label</option>
                    }
                }
            }
        </select>
        
        <input type="number" name="b" value="@num2" step="any"
               style="padding: 15px; font-size: 1.5em; width: 150px; border: 2px solid #667eea; border-radius: 5px;" />
        
        <button type="submit" style="padding: 15px 30px; font-size: 1.5em; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">
            Calculate!
        </button>
    </form>
    
    <div style="margin-top: 20px; padding: 20px; background: @(success ? "#d4edda" : "#f8d7da"); border-radius: 10px; font-size: 1.5em;">
        <strong>Result:</strong> @resultMessage
    </div>
</div>

@if (parseErrors.Any())
{
    <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border: 2px solid #ffc107; border-radius: 10px;">
        <h3 style="color: #856404;">âš ï¸ Parse Errors (handled in view!):</h3>
        <ul>
            @foreach (var error in parseErrors)
            {
                <li>@error</li>
            }
        </ul>
    </div>
}

<div style="margin-top: 20px; padding: 20px; background: #e8f4f8; border-radius: 10px;">
    <h2 style="color: #17a2b8;">ğŸ“Š Statistics (Calculated in View!)</h2>
    <p>Input numbers: @string.Join(", ", numbers.Select(n => n.ToString("F2")))</p>
    <table style="width: 100%; border-collapse: collapse;">
        <tr style="background: #17a2b8; color: white;">
            <th style="padding: 10px;">Sum</th>
            <th style="padding: 10px;">Average</th>
            <th style="padding: 10px;">Min</th>
            <th style="padding: 10px;">Max</th>
            <th style="padding: 10px;">Std Dev</th>
        </tr>
        <tr style="background: white;">
            <td style="padding: 10px; text-align: center;">@sum.ToString("F2")</td>
            <td style="padding: 10px; text-align: center;">@avg.ToString("F2")</td>
            <td style="padding: 10px; text-align: center;">@min.ToString("F2")</td>
            <td style="padding: 10px; text-align: center;">@max.ToString("F2")</td>
            <td style="padding: 10px; text-align: center;">@stdDev.ToString("F4")</td>
        </tr>
    </table>
</div>

<div style="margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
    <div style="padding: 20px; background: #fff; border: 2px solid #28a745; border-radius: 10px;">
        <h3 style="color: #28a745;">ğŸ“‹ JSON Parsed in View:</h3>
        <pre style="background: #f8f9fa; padding: 10px; overflow: auto;">@JsonSerializer.Serialize(jsonData, new JsonSerializerOptions { WriteIndented = true })</pre>
    </div>
    
    <div style="padding: 20px; background: #fff; border: 2px solid #fd7e14; border-radius: 10px;">
        <h3 style="color: #fd7e14;">ğŸ“„ CSV Parsed in View:</h3>
        <table style="width: 100%; border-collapse: collapse;">
            @foreach (var row in csvRows)
            {
                <tr>
                    @foreach (var cell in row)
                    {
                        <td style="padding: 5px; border: 1px solid #ddd;">@cell</td>
                    }
                </tr>
            }
        </table>
    </div>
    
    <div style="padding: 20px; background: #fff; border: 2px solid #6f42c1; border-radius: 10px;">
        <h3 style="color: #6f42c1;">ğŸ“œ XML Parsed in View:</h3>
        <ul>
            @foreach (var item in xmlItems)
            {
                <li>@item</li>
            }
        </ul>
    </div>
    
    <div style="padding: 20px; background: #fff; border: 2px solid #20c997; border-radius: 10px;">
        <h3 style="color: #20c997;">ğŸ• Date/Time (Converted in View!):</h3>
        <p><strong>Original:</strong> @data?.dateString</p>
        <p><strong>Parsed:</strong> @parsedDate</p>
        <p><strong>UTC:</strong> @utcTime</p>
        <p><strong>Local:</strong> @localTime</p>
    </div>
</div>

<div style="margin-top: 20px; padding: 20px; background: #dc3545; color: white; border-radius: 10px;">
    <h3>ğŸ”‘ Sensitive Data From Model (Exposed in View!):</h3>
    <p><strong>Connection String:</strong> @data?.connectionString</p>
    <p><strong>API Key:</strong> @data?.apiKey</p>
    <p><strong>Debug Mode:</strong> @data?.debugMode</p>
</div>

<div style="margin-top: 20px; padding: 20px; background: #343a40; color: white; border-radius: 10px;">
    <h3>ğŸ† Anti-Patterns Achieved in This View:</h3>
    <ul style="columns: 2;">
        <li>âœ… All business logic in Razor view</li>
        <li>âœ… Query string parsing in view</li>
        <li>âœ… Math calculations in view</li>
        <li>âœ… JSON parsing in view</li>
        <li>âœ… CSV parsing in view</li>
        <li>âœ… XML parsing in view</li>
        <li>âœ… Date conversions in view</li>
        <li>âœ… Statistics calculations in view</li>
        <li>âœ… Error handling in view</li>
        <li>âœ… Sensitive data displayed</li>
        <li>âœ… Controller does literally nothing</li>
        <li>âœ… ~150 lines of C# in a .cshtml file</li>
    </ul>
</div>
